name: CI/CD to AKS

on:
  push:
    branches:
      - main
  workflow_dispatch: 

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1️⃣ Login to Azure
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 2️⃣ Get ACR credentials
      - name: Azure CLI - Get ACR credentials
        run: |
          az acr login --name ${{ secrets.ACR_NAME }}

      # 3️⃣ Build and Push Docker images for each app
      - name: Build & Push app images
        run: |
          apps=("app" "app1" "app2")
          for app in "${apps[@]}"; do
            IMAGE=${{ secrets.ACR_NAME }}.azurecr.io/$app:${{ github.run_number }}
            echo "Building and pushing $IMAGE"
            docker build -t $IMAGE -f Dockerfile ./$app
            docker push $IMAGE
          done

      # 4️⃣ Set AKS Context
      - name: Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          cluster-name: ${{ secrets.AKS_CLUSTER }}
          resource-group: ${{ secrets.RESOURCE_GROUP }}

      # 5️⃣ Update manifests with new image tags
      - name: Update manifests images dynamically
        run: |
          apps=("app" "app1" "app2")
          for app in "${apps[@]}"; do
            IMAGE=${{ secrets.ACR_NAME }}.azurecr.io/$app:${{ github.run_number }}
            sed -i "s|image: .*$|image: $IMAGE|" manifests/${app}-deploy.yaml
          done

      # 6️⃣ Deploy to AKS
      - name: Deploy manifests to AKS
        run: |
          kubectl apply -f manifests/
          kubectl rollout status deployment/app
          kubectl rollout status deployment/app1
          kubectl rollout status deployment/app2

      # 7️⃣ Verify Services
      - name: Get Services Info
        run: kubectl get svc

